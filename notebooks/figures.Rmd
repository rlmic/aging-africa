---
title: "Demography of Aging in South Saharan Africa"
output: 
  bookdown::pdf_document2:
    toc: false
    extra_dependencies: ["flafter"]
    number_sections: true
    df_print: kable
    highlight: tango
    keep_tex: true
    fig_caption: yes
fontsize: 11pt
geometry: margin=1in
header-includes:
  \usepackage{pdflscape}
  \usepackage{lscape}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  fig.align = "center",
	fig.height = 4.5,
	fig.width = 5,
	message = FALSE,
	warning = FALSE,
  graphics.auto_pdf = FALSE
	)
```

```{r env, include=FALSE}
# Load & Install Packages
pacman::p_load(
  ggtext,
  tidyr, 
  haven, 
  plyr, 
  dplyr, 
  magrittr,
  ggplot2, 
  CGPfunctions, 
  scales, 
  ggh4x, 
  cowplot, 
  stats,
  stringr,
  reshape2,
  directlabels,
  ggstream,
  patchwork,
  ggrepel,
  forcats,
  ggh4x

)
source("../src/utils/constants.R")
source("../src/utils/funcs.R")
```

```{r data_load, include=FALSE}
data_list <- lapply(files_to_load, load_data)
names(data_list) <- gsub("\\.dta$", "", names_datas)
list2env(data_list, envir = .GlobalEnv)
```

```{r data_trans, include=FALSE}
# Main pipeline

subsaharan_weighted <- rbind(
  subsaharan_weighted %>% mutate(country = 'ssa'),
  countries_weighted
)
subsaharan_nonweighted <- rbind(
  subsaharan_nonweighted %>% mutate(country = 'ssa'),
  countries_nonweighted
)


proj_pop <- projections %>%
  select(country, pop_60plus_1990, pop_60plus_2020, pop_60plus_2050) %>%
  rename(
    `1990` = pop_60plus_1990,
    `2020` = pop_60plus_2020,
    `2050` = pop_60plus_2050
  ) %>%
  mutate(across(starts_with("19"), round, 0)) %>%
  gather(measurement, value, `1990`:`2050`, factor_key = TRUE) %>%
  filter(country %in% countries) %>%
  mutate(value = round(value, 1)) %>%
  mutate(
    measurement = factor(measurement, levels = breaks_text[-length(breaks_text)], ordered = TRUE)
  )

totpop <- pop_pro %>%
  select(
    countryregion, 
    pop_total_1990, 
    pop_total_2020, 
    pop_total_2050, 
    pop_total_2100
    ) %>%
  filter(countryregion %in% keepobs) %>%
  add_rest_of_world("pop_total") %>%
  reshape_and_clean("pop_total", keepobs, order) 

totpop$name_lab <- name_lab
totpop$measurement_x <- measurement_x
totpop$lab <- lab

over60 <- pop_pro %>%
  select(countryregion, pop_60plus_1990, pop_60plus_2020, pop_60plus_2050, pop_60plus_2100) %>%
  filter(countryregion %in% keepobs) %>%
  add_rest_of_world("pop_60plus") %>%
  reshape_and_clean("pop_60plus", keepobs, order)

# Additional adjustments for over60 labels
over60$name_lab <- c(
  NA, NA, NA, NA, '+ 171 %', '+ 155 %', '+ 121 %', NA, 
  '+ 100 %', '+ 144 %', '+ 194 %', NA,
  '- 29 %', '+ 59 %', '+ 313 %', NA
)
over60$lab <- c(
  '94 M ', '57 M ', '24 M', NA, NA, NA, NA, NA, 
  NA, NA, NA, NA,
  '362 M', '552 M', '644 M', NA
)

dep_rat_ov60 <- process_dependency_ratio(pop_pro, "depratio_15to59_", coun_comp)
old_age_rat_ov60 <- process_dependency_ratio(pop_pro, "oldagedepratio_15to59_", coun_comp)
dep_rat_ov65 <- process_dependency_ratio(pop_pro, "depratio_15to64_", coun_comp)
old_age_rat_ov65 <- process_dependency_ratio(pop_pro, "oldagedepratio_15to64_", coun_comp)

# Final adjustments for old_age_rat_ov60 and old_age_rat_ov65 labels
old_age_rat_ov60 <- old_age_rat_ov60 %>%
  mutate(name_lab = if_else(name_lab == 'Sub-Saharan Africa', 'Sub-Saharan Africa\n             Avg.', name_lab))

old_age_rat_ov65 <- old_age_rat_ov65 %>%
  mutate(name_lab = if_else(name_lab == 'Sub-Saharan Africa', 'Sub-Saharan Africa\n             Avg.', name_lab))


ssa <- ssa %>%
  mutate(
    gen = female,
    female = as.factor(female),
    age_group5 = as.factor(age_group5)
  ) %>%
  recode_values("female", c(`0` = 'Male', `1` = 'Female')) %>%
  recode_values("country", country_mapping) %>%
  mutate(
    region = ifelse(country %in% names(region_mapping), region_mapping[country], 'Other'),
    work_hrs = case_when(
      work_hrs >= 140 & work_hrs <= 168 ~ 140,
      work_hrs > 168 ~ NA_real_,
      TRUE ~ work_hrs
    ),
    depressed = ifelse(country == 'Nigeria', NA, depressed),
    gender = as.factor(female)
  )

stacked_labels <- data.frame(
  labels = rev(order),
  countryregion = rev(order),
  condition = c(2060, 2069, 2070, 2055),
  measurement = c(2670000, 5300000, 6600000, 8600000),
  color = c("black", "white", "white", "black")
)

dat <- dat %>%
  select(head(var_sum, -1)) %>%
  arrange(desc(govtexpgdp)) %>%
  mutate(cou = ifelse(country %in% countries, 1, 0),
         oopexp = 100 - oopexp)

dat_long <- prep_data_long(
  dat %>% filter(cou != 0),
  countries
)


# Apply the function for each income group
high_inco <- process_income_group(dat, 'HIC')
low_middle_inco <- process_income_group(dat, 'LMICs_nonSSA')
sub_sahar_inco <- process_income_group(dat, 'Sub-Saharan Africa')


# Main datasets transformed
outcomes_weighted_country = count_avera(
  subsaharan_weighted, measures
  ) 

outcomes_nonweighted_country = count_avera(
  subsaharan_nonweighted, measures
  ) 

outcomes_weighted_country_lim = count_avera(
  subsaharan_weighted, limitations
  )  

outcomes_nonweighted_country_lim = count_avera(
  subsaharan_nonweighted, limitations
  ) 


out_dis_weighted_gender = count_gender(
  gender_weighted, measures
  )  

outcomes_weighted_gender = count_gender(
  gender_weighted, limitations
  )  
```

```{r functions, include=FALSE}

get_count <- function(
    var
){
  ssa0 <- ssa
  ssa0
  ssa0$country = ''
  ssa0$region = "Average"
  ssa <- bind_rows(ssa0, ssa)
  annot0 = ssa %>% 
  filter(
    age==20 & gender=='Male'
    ) %>% 
  group_by(age_group5, country, gender, region) %>% 
    summarise(vari = mean(get(var), na.rm = TRUE), .groups = 'drop')
  
  
  # Calculate count for age >= 20 and non-NA gender
  annot1 = ssa %>% 
    filter(age >= 20 & !is.na(gender)) %>% 
    group_by(country, gender) %>% 
    summarise(n = sum(!is.na(country) & !is.na(get(var))), .groups = 'drop') %>%
    group_by(country) %>% 
    summarise(n = paste0("N=", scales::comma(sum(n), accuracy = 1)), .groups = 'drop')
  
  count <- merge(annot0, annot1, by = "country")
  
  return(count)
}


fac_row_agg_gen_dis <- function(
  data,
  vars,
  labels,
  forma_theme,
  size_count = 10
){
  
  condition.labs <- labels
  names(condition.labs) <- vars
  condition_order <- c(
    "diff_seei", 
    "diff_hear", 
    "diff_reme", 
    "diff_walk_clim", 
    "diff_self_care", 
    "diff_comm"
  )
  
  data$condition <- factor(data$condition, levels = condition_order)

  levels(data$age_group5) <- c(levels(data$age_group5), '')
  f_labels <- data.frame(
    condition = condition_order,  
    female = c("Male", "", "", "", "", ""),
    label = c("Male", "", "", "", "", "")
  )
  f_labels$condition = factor(f_labels$condition, levels = condition_order)

  f_labels2 <- data.frame(
    condition = condition_order,  
    female = c("Female", "", "", "", "", ""),
    label = c("Female", "", "", "", "", "")
  )
  f_labels2$condition = factor(f_labels2$condition, levels = condition_order)

  f_labels3 <- data.frame(
    condition = condition_order,  
    female = c("", "", "", "", "", "Female"),
    label = c("", "", "", "", "", "Female")
  )
  f_labels3$condition = factor(f_labels2$condition, levels = condition_order)

  
  f_labels4 <- data.frame(
    condition = condition_order,  
    condition = condition_order,  
    female = c("", "", "", "", "", "Male"),
    label = c("", "", "", "", "", "Male")
  )
  f_labels4$condition = factor(f_labels2$condition, levels = condition_order)

  data$female <- factor(data$female, levels = c(1, 0), labels = c("Female", "Male"))

  graph <- data %>%  
    filter(str_detect(condition, 'diff')) %>% 
    ggplot(
      aes(x = age_group5, y = measurement, group = female, color = female, linetype = female, size=female) # Added linetype aesthetic
    ) + 
    facet_wrap(
      . ~ condition, 
      ncol = 3, 
      labeller = labeller(condition = condition.labs)
    ) +
    geom_rect(
      aes(xmin = "60", xmax = "80", ymin = -Inf, ymax = Inf),
      alpha = 0.004,
      fill = "#344771",
      color= NA
    ) +
    theme_minimal() +
  geom_line(aes(size = female)) +  # Apply size mapping based on the 'female' variable
    geom_text(x = "55", y = 0.10, aes(label = label), data = f_labels, size = 9, color = "#050A30") +
    geom_text(x = "40", y = 0.17, aes(label = label), data = f_labels2, size = 9, color = "#8eb67d") +
        geom_text(x = "65", y = 0.15, aes(label = label), data = f_labels3, size = 9, color = "#8eb67d") +
    geom_text(x = "75", y = 0.08, aes(label = label), data = f_labels4, size = 9, color = "#050A30") +

    scale_fill_manual(values = c("#D3D3D3")) +        
    scale_color_manual(values = c("Male" = "#050A30", "Female" = "#8eb67d")) +  # Color Female lines with #8eb67d
    scale_linetype_manual(values = c("Male" = "longdash", "Female" = "solid")) +  # Line types for Male and Female
              scale_size_manual(values = c("Male" = 1, "Female" = 2)) +  # Thicker line for Female

    forma_theme
  
  return(graph)
}

fac_row_agg_count_out_gender <- function(
    data,
    vars,
    labels,
    forma_theme,
    size_count=10
){

  condition.labs <- labels
  names(condition.labs) <- vars
  condition_order <- measures

  
  data$condition <- factor(data$condition, levels = condition_order)

  levels(data$age_group5) <- c(levels(data$age_group5), '')
  f_labels <- data.frame(
    condition = condition_order,  
    female = c("Male",  "", "", "", "", "", "", "", ""),
    label = c("Male", "", "", "", "", "", "", "", "")
  )
  f_labels$condition = factor(f_labels$condition, levels = condition_order)

  f_labels2 <- data.frame(
    condition = condition_order,  
    female = c("Female",  "", "", "", "", "", "", "", ""),
    label = c("Female",  "", "", "", "", "", "", "", "")
  )
  f_labels2$condition = factor(f_labels2$condition, levels = condition_order)

  f_labels3 <- data.frame(
    condition = condition_order,  
    female = c("",  "", "", "", "", "", "", "", "Female"),
    label = c("",  "", "", "", "", "", "", "", "Female")
  )
  f_labels3$condition = factor(f_labels2$condition, levels = condition_order)

  
  f_labels4 <- data.frame(
    condition = condition_order,  
    female = c("",  "", "", "", "", "", "", "", "Male"),
    label = c("",  "", "", "", "", "", "", "", "Male")
  )
  f_labels4$condition = factor(f_labels2$condition, levels = condition_order)

  data$female <- factor(data$female, levels = c(1, 0), labels = c("Female", "Male"))
  
  graph <-data %>%  
    ggplot(
    aes(x = age_group5, y = measurement, group = female, color = female, linetype = female, size = female)
      ) +
    facet_wrap(
      . ~condition, 
      ncol = 3, 
      labeller = labeller(condition=condition.labs)
      ) +
    geom_rect(
      aes(xmin = "60", xmax = "80", ymin = -Inf, ymax = Inf),
      alpha = 0.004,
      fill = "#344771",
      color= NA
        ) +
    theme_minimal() +
  geom_line(aes(size = female)) +  # Apply size mapping based on the 'female' variable
    geom_text(x = "65", y = 0.25, aes(label = label), data = f_labels, size = 9, color = "#050A30" ) +
    geom_text(x = "65", y = 0.55, aes(label = label), data = f_labels2, size = 9, color = "#8eb67d") +
    geom_text(x = "65", y = 0.35, aes(label = label), data = f_labels3, size = 9, color = "#8eb67d") +
    geom_text(x = "75", y = 0.22, aes(label = label), data = f_labels4, size = 9, color = "#050A30") +

        scale_fill_manual(values = c("#D3D3D3")) +        
    scale_color_manual(values = c("Male" = "#050A30", "Female" = "#8eb67d")) +  # Color Female lines with #8eb67d

      scale_linetype_manual(values = c("Male" = "longdash", "Female" = "solid")) +

          scale_size_manual(values = c("Male" = 1, "Female" = 2)) +  # Thicker line for Female
  coord_cartesian(clip = "off")  +# Ensure text isn't clipped

    forma_theme
  
  
  return (graph)
}


```



```{r include=FALSE}

# Plot 2a
fig2a <- ggplot(totpop, aes(condition, measurement, fill = countryregion, label = countryregion)) +
  geom_area(type = "ridge", bw = 1) +
  geom_text(data = stacked_labels, aes(condition, measurement, label = labels), 
            hjust = 0, vjust = 0.5, color = stacked_labels$color, size = 8) +
  add_annotation(2100.2, cent(totpop, 1), "· 4.6B", "#818589", size_share) +
  add_annotation(2100.2, cent(totpop, 2), "· 0.8B", pal[3], size_share) +
  add_annotation(2100.2, cent(totpop, 3), "· 1.5B", pal[2], size_share) +
  add_annotation(2100.2, cent(totpop, 4), "· 3.4B", pal[1], size_share) +
  add_segment(2050, end_val(totpop, 2050)) +
  geom_point(aes(x = 2050, y = end_val(totpop, 2050)), color = "black") +
  add_annotation(2050, end_val(totpop, 2050) + 400000, "9.7B", "black", sz_tot) +
  add_segment(2020, end_val(totpop, 2020)) +
  geom_point(aes(x = 2020, y = end_val(totpop, 2020)), color = "black") +
  add_annotation(2020, end_val(totpop, 2020) + 400000, "7.8B", "black", sz_tot) +
  add_segment(1990, end_val(totpop, 1990)) +
  geom_point(aes(x = 1990, y = end_val(totpop, 1990)), color = "black") +
  add_annotation(1990, end_val(totpop, 1990) + 400000, "5.3B", "black", sz_tot) +
  add_segment(2100, end_val(totpop, 2100)) +
  geom_point(aes(x = 2100, y = end_val(totpop, 2100)), color = "black") +
  add_annotation(2100, end_val(totpop, 2100) + 400000, "10.3B", "black", sz_tot) +
  scale_fill_manual(values = pal) +
  coord_cartesian(clip = "off") +
  theme_minimal() +
  labs(title = '**A.** General Population (Total)', y = "", x = "") +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_blank(),
    plot.title = element_markdown(size = 20, color = "#344771", hjust = 0.5),
    axis.text.x = element_text(size = 20, margin = margin(5, 0, 0, 0)),
    plot.margin = margin(-1, 20, 0, 2),
    legend.position = "none"
  ) +
  scale_x_continuous(breaks = breaks_numer, labels = breaks_text)

# Plot 2b
fig2b <- ggplot(over60, aes(condition, measurement, fill = countryregion, label = countryregion)) +
  geom_area(type = "ridge", bw = 1) +
  add_annotation(2100.2, cent(over60, 1), "· 1.5B", "#818589", size_share) +
  add_annotation(2100.2, cent(over60, 2), "· 362M", pal[3], size_share) +
  add_annotation(2100.2, cent(over60, 3), "· 552M", pal[2], size_share) +
  add_annotation(2100.2, cent(over60, 4), "· 644M", pal[1], size_share) +
  add_segment(1990, end_val(over60, 1990)) +
  geom_point(aes(x = 1990, y = end_val(over60, 1990)), color = "black") +
  add_annotation(1990, end_val(over60, 1990) + 120000, "483M", "black", sz_tot) +
  add_segment(2020, end_val(over60, 2020)) +
  geom_point(aes(x = 2020, y = end_val(over60, 2020)), color = "black") +
  add_annotation(2020, end_val(over60, 2020) + 120000, "1,061M", "black", sz_tot) +
  add_segment(2050, end_val(over60, 2050)) +
  geom_point(aes(x = 2050, y = end_val(over60, 2050)), color = "black") +
  add_annotation(2050, end_val(over60, 2050) + 120000, "2,132M", "black", sz_tot) +
  add_segment(2100, end_val(over60, 2100)) +
  geom_point(aes(x = 2100, y = end_val(over60, 2100)), color = "black") +
  add_annotation(2100, end_val(over60, 2100) + 120000, "3,084M", "black", sz_tot) +
  scale_fill_manual(values = pal) +
  coord_cartesian(clip = "off") +
  theme_minimal() +
  labs(title = '**B.** Over 60 Population (Total)', y = "", x = "") +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_blank(),
    plot.title = element_markdown(size = 20, color = "#344771", hjust = 0.5),
    axis.text.x = element_text(size = 20, margin = margin(5, 0, 0, 0)),
    plot.margin = unit(c(0, 0.75, 0, 0), "inches"),
    legend.position = "none"
  ) +
  scale_x_continuous(breaks = breaks_numer, labels = breaks_text)

# Plot 2c

fig2c <- create_plot(
  totpop, 
  title = '**C.** General Population (Growth)', 
  y_limits = c(0, 500000, 1000000, 1500000, 2000000, 2500000, 3000000, 3500000), 
  y_labels = c("0", "-", "1B", "-", "2B", "-", "3B", "-")
) + geom_text_repel(
    aes(color = countryregion, label = name_lab),
    segment.angle = 10,
    size = 7.5,
    direction = "y",
    hjust = 0,
    vjust = 1.7,
    segment.size = .4,
    segment.alpha = .5,
    segment.linetype = "dotted",
    box.padding = .2,
    segment.curvature = -0.1
    ) 

# Plot 2d

fig2d <- create_plot(
  over60, 
  title = '**D.** Over 60 Population (Growth)', 
  y_limits = c(0, 200000, 400000, 600000, 800000), 
  y_labels = c("0", "-", "400M", "-", "800M")
) 
```


```{r pop_grow, echo=FALSE, fig.height=6, fig.width=5, dev = c("png"), dpi=100}
# Figure 1: Panel B: Over-60 population (m.)
newggslopegraph(
  dataframe = proj_pop,
  Times = measurement,
  Measurement = value,
  Grouping = country,
  Title = "",
  SubTitle = "",
  Caption = NULL,
  DataTextSize = 4,
  YTextSize = 4,
  XTextSize = 15,
  TitleTextSize = 10,
  SubTitleTextSize = 2,
  LineThickness = 1,
  LineColor = rep(c_green, nrow(proj_pop)),  # Repeating the color for each row
  WiderLabels = TRUE,
  ThemeChoice = "minimal"
  )
```

```{r ov60_pop, echo=FALSE, fig.height=7.5, fig.width=18, dev = c("png"), dpi=100}
# Figure 2: Projected Population Growth and Dependency Ratios
# Panels A & B
fig2a | fig2b  
```

```{r ov60_growth, echo=FALSE, fig.height=7.5, fig.width=18, dev = c("png"), dpi=100}
# Figure 2: Projected Population Growth and Dependency Ratios
# Panels C & D
fig2c | fig2d
```


```{r ov60_dep_rat, echo=FALSE, fig.height=7.5, fig.width=18, dev=c("png"), dpi=100}
# Figure 2: Projected Population Growth and Dependency Ratios
# Panels E & F
depratov60 <- create_dependency_ratio_plot(
  data = dep_rat_ov60,
  title = "**E.-** General Population (Dependency Ratio)",
  line_sizes = c(0.9, 0.9, 1.6),
  color_scheme = colors_scheme,
  breaks_numer = breaks_numer,
  breaks_text = breaks_text,
  include_country_labels = TRUE
)

oldageratov60 <- create_dependency_ratio_plot(
  data = old_age_rat_ov60,
  title = "**F.-** Over 60 Population (Dependency Ratio)",
  line_sizes = c(0.9, 0.9, 1.6),
  y_labels = c("0", "-", "0.5", "-", "1", "1.25", "1.50"),
  color_scheme = colors_scheme,
  breaks_numer = breaks_numer,
  breaks_text = breaks_text,
  include_country_labels = FALSE
)
wrap_elements(panel = depratov60  + oldageratov60 ) +
  labs(tag = "**Year**") +
  theme(
    plot.tag = element_markdown(size=20, color="#344771"),
    plot.tag.position = "bottom"
  )

```


```{r out_agg_ctr_wgt, echo=FALSE,  fig.height=25, fig.width=25, dev = c("png"), dpi=100}
# Figure 3: Employment, Health, & Living Arrangements over the Life Course: Aggregate
meas_labs_text <- data.frame(
  condition = measures, 
  country = c("Average", "", "", "", "", "", "", "", ""),
  label = c("Average", "", "", "", "", "", "", "", "Average")
)
country_average(
    data = outcomes_weighted_country,
    vars = measures,
    labels = measures_labs_agg,
    forma_theme = theme_top_count(),
    f_labels_data = meas_labs_text
    ) %>% forma_axes(
    bre_age = bre_age, lab_age = lab_age
    )
```


```{r out_agg_gen_wgt,  echo=FALSE, fig.height=25, fig.width=25, dev = c("png"), dpi=100}
# Figure 4: Employment, Health, & Living Arrangements over the Life Course: by Gender
fac_row_agg_count_out_gender(
  out_dis_weighted_gender,
  measures,
  measures_labs_agg,
  theme_top_count()
  ) %>% forma_axes(
    bre_age = bre_age, lab_age = lab_age
    )
```

```{r dis_agg_ctr_wgt, echo=FALSE,  fig.height=12, fig.width=19, dev = c("png"), dpi=100}
# Figure 5: Functional Limitations over the Life Course
limi_labs_text <- data.frame(
  condition = limitations, 
  country = c("Average", "", "", "", "", ""),
  label = c("Average", "", "", "", "", "Average")
)
country_average(
    data = outcomes_weighted_country_lim,
    vars = limitations,
    labels = limitations_labs,
    forma_theme = theme_top_count(size_text = 23, size_title = 28, size_legend = 18, color = "#344771"),
    f_labels_data = limi_labs_text,
    filter_condition = "str_detect(condition, 'diff')",
    geom_text_y = 0.15
    ) %>% forma_axes(
    bre_age = bre_age, lab_age = lab_age
    )
```



```{r dis_agg_gen_wgt, echo=FALSE,  fig.height=12, fig.width=19, dev = c("png"), dpi=100}
# Figure 6: Functional Limitations over the Life Course By Gender
fac_row_agg_gen_dis(
  outcomes_weighted_gender,
  limitations,
  limitations_labs,
  theme_top_count(
    size_text=23,
    size_title=28,
    size_legend=18,
    color="#344771"
    )
  ) %>% forma_axes(
    bre_age = bre_age, lab_age = lab_age
    )
```

```{r hea_care, echo=FALSE, fig.height=7.5, fig.width=15, dev = c("png"), dpi=100}
# Figure 7: Social Protection across Selected Sub-Saharan African Countries
indi_coun_regi(
  vars=indicators,
  labs=indicato_labeller
  )

```

```{r environ, echo=FALSE, fig.height=7.5, fig.width=18, dev = c("png"), dpi=100}
#Figure 8: Health Spending and Health Care Capacity across Selected Sub-Saharan African Countries
indi_coun_regi(
  vars=var_hea,
  labs=labeller_health
  )
```






```{r ov65_dep_rat, echo=FALSE, fig.height=7.5, fig.width=18, dev=c("png"), dpi=100}
# Online Appendix Figure A1: Dependency Ratios (over-65)

depratov65 = create_dependency_ratio_plot(
  data = dep_rat_ov65,
  title = "**A.-** General Population (Dependency Ratio)",
  line_sizes = c(1.4, 1.4, 1.4),
  color_scheme = colors_scheme,
  breaks_numer = breaks_numer,
  breaks_text = breaks_text,
  include_country_labels = TRUE
)

oldageratov65 <- create_dependency_ratio_plot(
  data = old_age_rat_ov65,
  title = "**B.-** Over 65 Population (Dependency Ratio)",
  line_sizes = c(0.9, 0.9, 1.6),
  y_labels = c("0", "-", "0.5", "-", "1", "1.25", "1.50"),
  color_scheme = colors_scheme,
  breaks_numer = breaks_numer,
  breaks_text = breaks_text,
  include_country_labels = FALSE
)

wrap_elements(panel = depratov65  + oldageratov65) +
  labs(tag = "**Year**") +
  theme(
    plot.tag = element_markdown(size=20, color="#344771"),
    plot.tag.position = "bottom"
  )
```





```{r outcomes_gender_weighted, echo=FALSE, fig.height=70, fig.width=45, dev = c("png"), dpi=100}
# Online Appendix Figure A3: Employment, Health, & Living Arrangements over the Life Course by Country and Gender WEIGHTED
meas_count_gend(
  weighted = TRUE, 
  breaks_y = c(0, 0.5, 1), 
  limits_y = c(0, 1.2), 
  labels_y = c('0', '-', '1'), 
  breaks_x = bre_age, 
  labels_x = lab_age,
  data_cols = measures, 
  y_labels = measures_labs, 
  order_first = "pop_row", 
  custom_plots = NULL, 
  themes = list("urban" = theme_bottom())
)
```


```{r disabilities_gender_weighted, echo=FALSE, fig.height=35, fig.width=45, dev = c("png"), dpi=100}
# Online Appendix Figure A4: Functional Limitations over the Life Course by Country and Gender
meas_count_gend(
  weighted = TRUE, 
  breaks_y = c(0, 0.5, 1), 
  limits_y = c(0, 1.2), 
  labels_y = c('0', '-', '1'), 
  breaks_x = bre_age, 
  labels_x = lab_age,
  data_cols = limitations, 
  y_labels = limit_labs, 
  order_first = "", 
  custom_plots = NULL, 
  themes = list(
  "diff_seei" = theme_top(),
  "diff_reme" = theme_bottom(),
  "diff_comm" = theme_bottom()
  )
)

```

```{r outcomes_aggregate_nonweighted, echo=FALSE,  fig.height=25, fig.width=25, dev = c("png"), dpi=100}
# Online Appendix Figure A5: Employment, Health, & Living Arrangements over the Life Course: Aggregate, no weights

country_average(
    data = outcomes_nonweighted_country,
    vars = measures,
    labels = measures_labs_agg,
    forma_theme = theme_top_count(),
    f_labels_data = meas_labs_text
    ) %>% forma_axes(bre_age = bre_age, lab_age = lab_age)
```


#A6

```{r outcomes_gender_nonweighted, echo=FALSE, fig.height=60, fig.width=45, dev = c("png"), dpi=100}
## Online Appendix Figure A7: Employment, Health, & Living Arrangements over the Life Course: by Country and Gender, no weights
meas_count_gend(
  weighted = FALSE, 
  breaks_y = c(0, 0.5, 1), 
  limits_y = c(0, 1.2), 
  labels_y = c('0', '-', '1'), 
  breaks_x = bre_age, 
  labels_x = lab_age,
  data_cols = measures, 
  y_labels = measures_labs, 
  order_first = "pop_row", 
  custom_plots = NULL, 
  themes = list("urban" = theme_bottom())
)
```


```{r disabilities_aggregate_nonweighted, echo=FALSE,  fig.height=12, fig.width=19, dev = c("png"), dpi=100}
# Online Appendix Figure A8: Functional Limitations over the Life Course: Aggregate, no weights

country_average(
    data = outcomes_nonweighted_country_lim,
    vars = limitations,
    labels = limitations_labs,
    forma_theme = theme_top_count(size_text = 23, size_title = 28, size_legend = 18, color = "#344771"),
    f_labels_data = limi_labs_text,
    filter_condition = "str_detect(condition, 'diff')",
    geom_text_y = 0.15
    ) %>% forma_axes(bre_age = bre_age, lab_age = lab_age)
```


#A9


```{r disabilities_gender_nonweighted, echo=FALSE, fig.height=35, fig.width=45, dev = c("png"), dpi=100}
#Online Appendix Figure A10: Functional Limitations over the Life Course: by Country and Gender, no weights
meas_count_gend(
  weighted = FALSE, 
  breaks_y = c(0, 0.5, 1), 
  limits_y = c(0, 1.2), 
  labels_y = c('0', '-', '1'), 
  breaks_x = bre_age, 
  labels_x = lab_age,
  data_cols = limitations, 
  y_labels = limit_labs, 
  order_first = "", 
  custom_plots = NULL, 
  themes = list(
  "diff_seei" = theme_top(),
  "diff_reme" = theme_bottom(),
  "diff_comm" = theme_bottom()
  )
)
```

