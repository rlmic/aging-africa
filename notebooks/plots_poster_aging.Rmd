---
title: "Demography of Aging in South Saharan Africa"
output: 
  bookdown::pdf_document2:
    toc: false
    extra_dependencies: ["flafter"]
    number_sections: true
    df_print: kable
    highlight: tango
    keep_tex: true
    fig_caption: yes
fontsize: 11pt
geometry: margin=1in
header-includes:
  \usepackage{pdflscape}
  \usepackage{lscape}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  fig.align = "center",
	fig.height = 4.5,
	fig.width = 5,
	message = FALSE,
	warning = FALSE
	)
```


\listoffigures
\newpage



```{r include=FALSE}
library(tidyr)
library(haven)
library(plyr)
library(dplyr)
library(ggplot2)
library(formattable)
library(ggh4x)
library(gridExtra)
library(ggtext)

library(ggtree)
library(dplyr)
library(ggstance)
library(cowplot)
# devtools::install_github("YuLab-SMU/treeio")
# devtools::install_github("YuLab-SMU/ggtree")
library(tidytree)
library("ggsci")
library(stringr)


ssa = read_dta("../data/preprocessed/allcountries.dta")
ssa$gen <- ssa$female
ssa$female <- as.factor(ssa$female)

ssa$age_group5 <- as.factor(ssa$age_group5)

ssa = ssa %>% 
    mutate(
      female = case_when(
      female==0
       ~ 'Male',
      female ==1
      ~ 'Female',
      TRUE ~ NA), 
      country = case_when(
        country == 'eth'
         ~ 'ETHIOPIA',
        country == 'mlw'
         ~ 'MALAWI',  
        country == 'nga'
         ~ 'NIGERIA',  
        country == 'tza'
         ~ 'TANZANIA',  
        country == 'gha'
         ~ 'GHANA', 
        country == 'saf'
        ~ 'SOUTH AFRICA',
      TRUE ~ NA), 

      work_hrs = case_when(
        work_hrs>=140 & work_hrs<=168 ~ 140,
        work_hrs>168 ~ NA,
        TRUE ~ work_hrs
      ))
ssa$gender <- as.factor(ssa$female)
```


```{r echo=FALSE}

theme_top <- function(
    size_text=15,
    size_title=18,
    size_legend=20,
    color="#14213D"
){
  top = theme(
    axis.title.x = element_blank(),
    strip.background = element_rect(fill="white"),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position="top", 
    legend.title=element_blank(),
    text = element_text(size = size_text), 
    legend.text = element_text(
      margin = margin(t = size_legend, b = size_legend, unit = "pt"),
      size=size_legend
      ),
    legend.key.size = unit(6,"line"), 
    strip.text = element_text(color = color, size=size_title),
    axis.title.y = element_text(angle = 0)
    )

  return (top)
}

theme_middle <- function(
    size_text=15,
    size_title=15,
    color="#000C66"
){
  middle = theme(
    strip.background = element_blank(),
    strip.text.x = element_blank(), 
    legend.position="none",
    text = element_text(size = size_text),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_text(angle = 0)
    )

  return (middle)
}

theme_middle_wline <- function(
    size_text=15,
    size_title=15,
    color="#14213D"
){
  middle = theme(
    strip.background = element_blank(),
    strip.text.x = element_blank(), 
    legend.position="none",
    text = element_text(size = size_text),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_text(angle = 0),
    axis.line.x = element_line(size = 0.5, linetype="solid", colour=color)
    )

  return (middle)
}

theme_bottom <- function(
    size_text=15,
    size_title=15,
    color="#000C66"
){
  bottom = theme(
    strip.background = element_blank(),
    strip.text.x = element_blank(), 
    legend.position="none",
    text = element_text(size = size_text),
    strip.text = element_text(color=color, size=size_title),
    axis.title.y = element_text(angle = 0)
    )

  return (bottom)
}

get_count <- function(
    var
){
  annot0 = ssa %>% 
  filter(
    age==20 & gender=='Male'
    ) %>% 
  group_by(age_group5, country, gender) %>% 
  summarise(vari = mean(get(var), na.rm=TRUE))
  
  annot1 = ssa %>% 
    filter(
      age>=20 & !is.na(gender) 
      ) %>% group_by(country, gender) %>% 
    summarise(
      n = sum(!is.na(country)&!is.na(get(var)))
      ) %>% 
    group_by(country) %>% 
    summarise(n = paste0("N=", comma(sum(n), digits = 0)))
  
  count <- merge(annot0, annot1, by="country")
  
  return (count)
}


fac_row_popu <- function(
    forma_theme,
    colors=c("#8eb67d","#000C66"),
    breaks=c("20","25","30", "35", "40", "45", "50", "55", "60", "65", "70", "75", "80"),
    labels=c("20", "", "", "", "40", "", "",  "", "60", "", "", "", "80+")
){
  
  dat = get_count("gender")

  graph <- ssa %>%
    filter(age>=20  & !is.na(gender)) %>%
    group_by(country, age_group5, gender) %>%
    tally() %>% 
    ggplot(
      aes(x = age_group5, y = n, colour = gender, group=gender)
      ) + 
    theme_minimal() +
    geom_line(size = 0.8, aes(linetype=gender)) +
    facet_nested(~country, scales='free_y', space="free_y") +
    scale_color_manual(values = colors) +
    scale_linetype_manual(values=c("solid", "longdash")) +
    scale_x_discrete(
      breaks=breaks,
      labels=labels
      ) +
    geom_text(
      data = dat, 
      label=dat$n,
      aes(label = paste0("N=", n), y = Inf, x  = -Inf),
      vjust = 1.3,
      colour="#14213D",
      hjust = -0.2) +
    forma_theme

  
  return (graph)
}


fac_row <- function(
    var,
    forma_theme,
    colors=c("#8eb67d","#000C66"),
    breaks=c("20","25","30", "35", "40", "45", "50", "55", "60", "65", "70", "75", "80"),
    labels=c("20", "", "", "", "40", "", "",  "", "60", "", "", "", "80+")
){
  
  dat = get_count(var)
  
  graph <- ssa %>% 
    filter(
      age>=20 & !is.na(gender) 
      ) %>% 
    group_by(age_group5, country, gender) %>% 
    summarise(vari = mean(get(var), na.rm=TRUE)) %>% 
    ggplot(
      aes(x = age_group5, y = vari, colour = gender, group=gender)
      ) + 
    theme_minimal() +
    geom_line(size = 0.8, aes(linetype=gender)) +
    facet_nested(~country, scales='free_y', space="free_y") +
    scale_color_manual(values = colors) +
    scale_linetype_manual(values=c("solid", "longdash")) +
    scale_x_discrete(
      breaks=breaks,
      labels=labels
      ) +
    geom_text(
      data = dat, 
      label=dat$n,
      aes(label = paste0("N=", n), y = Inf, x  = -Inf),
      vjust = 1.3,
      colour="#14213D",
      hjust = -0.2) +
    forma_theme

  
  return (graph)
}

```

\begin{landscape}

```{r employmenthours, fig.cap="Employment. Age Group and Gender.", echo=FALSE, fig.height=20, fig.width=25}
a <- fac_row_popu( theme_top()) + labs(y = "Population\n(Count)")
b <- fac_row("urban", theme_middle_wline()) + labs(y = "Urban Status\n(Proportion)")
c <- fac_row("work_hrs", theme_middle()) + labs(y = "Employment\n(Hours)")
d <- fac_row("work_any", theme_middle_wline()) + labs(y = "Employment\n(Proportion)")
e <- fac_row("notmarried", theme_middle()) + ylim(0, 0.6) + labs(y = "Living Arrangements\nUnmarried\n(Proportion)")
f <- fac_row("lives_alone", theme_middle_wline()) + ylim(0, 0.6) + labs(y = "Living Arrangements\nLives alone\n(Proportion)")
g <- fac_row("ill_inj", theme_middle()) + ylim(0, 0.6) + labs(y = "Health\nIllness/Injury\n(Proportion)")
h <- fac_row("ill_inj_stopactivity", theme_middle()) + ylim(0, 0.6) + labs(y = "Health\nStopped\nActivities\n(Proportion)")
i <- fac_row("depressed", theme_bottom()) + ylim(0, 0.6) + labs(y = "Health\nDepression", x = "Age", caption = paste(str_wrap("*Measurements derive from the Living Standards Measurement Study (LSMS), except for the outcomes corresponding to South Africa and Ghana, which come from the National Income Dynamics Study (NIDS) and the Ghana Socioeconomic Panel Survey (GSPS, respectively.", 170), collapse = "\n" ), adj=+1)
plot_grid(plotlist=list(a, b, c, d, e, f, g, h, i), ncol=1, align='v', rel_heights = c(10, 5, 5, 5, 5, 5, 5, 5, 7))

```


\end{landscape}